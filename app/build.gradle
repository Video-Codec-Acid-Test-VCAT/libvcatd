/*
* VCAT (Video Codec Acid Test)
*
* SPDX-FileCopyrightText: Copyright (C) 2020-2025 VCAT authors and RoncaTech
* SPDX-License-Identifier: GPL-3.0-or-later
*
* This file is part of VCAT.
*
* VCAT is free software: you can redistribute it and/or modify it
* under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* You should have received a copy of the GNU General Public License
* along with VCAT. If not, see <https://www.gnu.org/licenses/gpl-3.0.html>.
*
* For commercial use, contact RoncaTech LLC for a written waiver or license:
* https://roncatech.com/legal
*/

plugins {
    id 'com.android.library'
    id 'maven-publish'
    id 'signing'
}

group   = 'com.roncatech.vcat'
version = '0.0.2.0'

def abis   = ['arm64-v8a','armeabi-v7a']
def minApi = 29

android {
    namespace 'com.roncatech.libvcat'
    compileSdk 35
    ndkVersion "27.0.12077973"

    defaultConfig {
        minSdk minApi
        targetSdk 35
        ndk { abiFilters.addAll(abis) }

        // CMake gets dav1d install dirs per ABI
        externalNativeBuild {
            cmake {
                arguments "-DDAV1D_INSTALL_ARM64_V8A=${layout.buildDirectory.dir('dav1d/install-arm64-v8a').get().asFile.absolutePath}",
                        "-DDAV1D_INSTALL_ARMEABI_V7A=${layout.buildDirectory.dir('dav1d/install-armeabi-v7a').get().asFile.absolutePath}"
            }
        }

        consumerProguardFiles 'consumer-rules.pro'
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'),'proguard-rules.pro'
        }
        debug { debuggable true }
    }

    externalNativeBuild { cmake { path file('src/main/cpp/CMakeLists.txt') } }

    // Publish only release; AGP adds sources.jar
    publishing { singleVariant("release") { withSourcesJar() } }

    sourceSets {
        main {
            jniLibs.srcDirs 'src/main/jniLibs'
            resources.srcDirs 'src/main/resources'
        }
    }
}

/* ===== dav1d build (Meson/Ninja) ===== */

def ndkDirProvider  = providers.provider { android.ndkDirectory?.absolutePath }
def hostTagProvider = providers.provider {
    def ndk = ndkDirProvider.getOrNull()
    if (!ndk) return null
    for (tag in ['darwin-arm64','darwin-x86_64','linux-x86_64']) {
        if (file("${ndk}/toolchains/llvm/prebuilt/${tag}/bin").exists()) return tag
    }
    return null
}
def triplet = { abi -> abi == 'arm64-v8a' ? 'aarch64-linux-android' : 'armv7a-linux-androideabi' }
def ccFor    = { abi, ndk, tag -> "${ndk}/toolchains/llvm/prebuilt/${tag}/bin/${triplet(abi)}${minApi}-clang" }
def cxxFor   = { abi, ndk, tag -> "${ndk}/toolchains/llvm/prebuilt/${tag}/bin/${triplet(abi)}${minApi}-clang++" }
def arFor    = { ndk, tag -> "${ndk}/toolchains/llvm/prebuilt/${tag}/bin/llvm-ar" }
def stripFor = { ndk, tag -> "${ndk}/toolchains/llvm/prebuilt/${tag}/bin/llvm-strip" }

def workRoot    = layout.buildDirectory.dir('dav1d').get().asFile
def dav1dSrcDir = new File(workRoot, 'src')
def dav1dRef    = (findProperty('dav1dRef') ?: '1.5.1') as String
def dav1dRemote = (findProperty('dav1dRemote') ?: 'https://code.videolan.org/videolan/dav1d.git') as String
def dav1dLocal  = (findProperty('DAV1D_SRC') ?: System.getenv('DAV1D_SRC')) as String // optional override

tasks.register('fetchDav1d') {
    outputs.dir(dav1dSrcDir)
    doLast {
        workRoot.mkdirs()

        if (dav1dLocal) {
            delete dav1dSrcDir
            copy { from dav1dLocal; into dav1dSrcDir; exclude '.git' }
            return
        }
        def clearGitEnv = { spec -> spec.environment.remove('GIT_DIR'); spec.environment.remove('GIT_WORK_TREE') }

        if (!dav1dSrcDir.exists()) {
            exec { workingDir workRoot; clearGitEnv(delegate)
                commandLine 'git','clone','--depth','1','--branch', dav1dRef, dav1dRemote,'src' }
        } else if (!new File(dav1dSrcDir,'.git').exists()) {
            delete dav1dSrcDir
            exec { workingDir workRoot; clearGitEnv(delegate)
                commandLine 'git','clone','--depth','1','--branch', dav1dRef, dav1dRemote,'src' }
        } else {
            exec { workingDir dav1dSrcDir; clearGitEnv(delegate); commandLine 'git','fetch','--depth','1','origin', dav1dRef }
            exec { workingDir dav1dSrcDir; clearGitEnv(delegate); commandLine 'git','checkout','-f', dav1dRef }
            exec { workingDir dav1dSrcDir; clearGitEnv(delegate); commandLine 'git','reset','--hard','FETCH_HEAD' }
        }
    }
}

tasks.register('cleanDav1d') { doLast { delete workRoot } }

abis.each { abi ->
    def crossFile  = layout.buildDirectory.file("dav1d/toolchains/meson-${abi}.ini").get().asFile
    def buildDir   = new File(workRoot, "build-${abi}")
    def installDir = new File(workRoot, "install-${abi}")

    tasks.register("genCrossFile_${abi}") {
        dependsOn 'fetchDav1d'
        outputs.file(crossFile)
        doLast {
            def ndk = ndkDirProvider.get(); def tag = hostTagProvider.get()
            if (!ndk || !tag) throw new GradleException("NDK not found. Ensure ndkVersion ${android.ndkVersion} is installed.")

            crossFile.parentFile.mkdirs()
            crossFile.text = """
[binaries]
c = '${ccFor(abi, ndk, tag)}'
cpp = '${cxxFor(abi, ndk, tag)}'
ar = '${arFor(ndk, tag)}'
strip = '${stripFor(ndk, tag)}'
pkg-config = 'false'

[built-in options]
c_std = 'c11'
cpp_std = 'c++17'
werror = false
default_library = 'static'

[host_machine]
system = 'android'
cpu_family = '${abi == 'arm64-v8a' ? 'aarch64' : 'arm'}'
cpu = '${abi == 'arm64-v8a' ? 'armv8' : 'armv7'}'
endian = 'little'
""".stripIndent()
        }
    }

    tasks.register("buildDav1d_${abi}") {
        dependsOn "genCrossFile_${abi}"
        outputs.dir(installDir)
        doLast {
            buildDir.mkdirs(); installDir.mkdirs()
            exec {
                workingDir buildDir
                commandLine 'meson','setup','.', dav1dSrcDir.absolutePath,
                        '--cross-file', crossFile.absolutePath,
                        '-Ddefault_library=static','-Denable_asm=true',
                        '-Denable_tests=false','-Dbuildtype=release',
                        '--prefix', installDir.absolutePath
            }
            exec { workingDir buildDir; commandLine 'ninja' }
            exec { workingDir buildDir; commandLine 'ninja','install' }
        }
    }
}

// Ensure dav1d built before JNI compile/configure
tasks.named('preBuild').configure { dependsOn abis.collect { "buildDav1d_${it}" } }

/* ===== Publishing to Maven Central ===== */

// Minimal javadoc jar (ok for Central)
tasks.register('androidJavadocJar', Jar) { archiveClassifier = 'javadoc' }

publishing {
    publications {
        // Avoid "release" name; use a safe, unique name
        create('mavenRelease', MavenPublication) {
            groupId    = project.group
            artifactId = 'libvcat'
            version    = project.version

            // Defer wiring the Android component until variants exist
            afterEvaluate { from(components.getByName('release')) }

            // sources.jar comes from withSourcesJar()
            artifact(tasks.named('androidJavadocJar'))

            pom {
                name.set('VCAT libvcat')
                description.set('Video Codec Acid Test core library (pre-release)')
                url.set('https://roncatech.com')
                licenses {
                    license {
                        name.set('RoncaTech Pre-Release License')
                        url.set('https://roncatech.com/legal/pre-release-license') // swap to GPL-3 when public
                        distribution.set('repo')
                    }
                }
                scm {
                    url.set('https://github.com/jonathannah/vcat') // can be private for now
                    connection.set('scm:git:https://github.com/jonathannah/vcat.git')
                    developerConnection.set('scm:git:ssh://git@github.com/jonathannah/vcat.git')
                }
                developers { developer { id.set('roncatech'); name.set('RoncaTech LLC') } }
            }
        }
    }
}

signing {
    // Use system gpg or in-memory keys; configure creds in ~/.gradle/gradle.properties
    // e.g., signing.gnupg.keyName=CC5B04DC37D33206, signing.gnupg.passphrase=ABC 123
    useGpgCmd()
    sign publishing.publications['mavenRelease']
}

// Build a Central Portal bundle ZIP rooted at 'com/'
tasks.register('bundleForCentral', Zip) {
    dependsOn 'publishToMavenLocal'
    archiveFileName = "libvcat-${project.version}.zip"
    destinationDirectory = layout.buildDirectory.dir("central-bundles")
    from(new File(System.getProperty("user.home"),
            ".m2/repository/com/roncatech/vcat/libvcat/${project.version}")) {
        into "com/roncatech/vcat/libvcat/${project.version}"
    }
}

// put this in that module's build.gradle (same file as your publishing block)
import java.security.MessageDigest

def checksum = { File f, String algo ->
    def md = MessageDigest.getInstance(algo)
    f.withInputStream { is ->
        byte[] buf = new byte[8192]; int r
        while ((r = is.read(buf)) != -1) md.update(buf, 0, r)
    }
    md.digest().collect { String.format("%02x", it) }.join()
}

tasks.register('addLegacyChecksums') {
    dependsOn 'publishToMavenLocal'
    doLast {
        def v = project.version
        def dir = new File(System.getProperty('user.home'),
                ".m2/repository/com/roncatech/vcat/libvcat/${v}")
        if (!dir.isDirectory()) throw new GradleException("Repo dir not found: $dir")

        def targets = dir.listFiles().findAll { f ->
            f.name.endsWith(".aar") || f.name.endsWith(".pom") ||
                    f.name.endsWith(".module") || f.name.endsWith("-sources.jar") ||
                    f.name.endsWith("-javadoc.jar")
        }

        targets.each { f ->
            [["md5","MD5"], ["sha1","SHA-1"]].each { ext, algo ->
                new File(f.parentFile, "${f.name}.${ext}").text = checksum(f, algo)
            }
        }
        logger.lifecycle("Checksums written for ${targets.size()} files in $dir")
    }
}

// ensure the ZIP includes them
tasks.named('bundleForCentral').configure { dependsOn 'addLegacyChecksums' }


/* ===== Dependencies ===== */
dependencies {
    compileOnly "androidx.annotation:annotation:1.7.1"
    compileOnly "com.google.android.exoplayer:exoplayer-core:2.19.1"
}
